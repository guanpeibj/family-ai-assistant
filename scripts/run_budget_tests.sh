#!/bin/bash
# é¢„ç®—åŠŸèƒ½ä¸€é”®æµ‹è¯•è„šæœ¬

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                 FAA é¢„ç®—åŠŸèƒ½æµ‹è¯•å¥—ä»¶                         â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# æ£€æŸ¥Dockerå®¹å™¨çŠ¶æ€
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "æ­¥éª¤1ï¼šæ£€æŸ¥å®¹å™¨çŠ¶æ€"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
docker-compose ps | grep -E "faa-api|faa-mcp|postgres"
echo ""

# é€‰æ‹©æµ‹è¯•ç±»å‹
echo "è¯·é€‰æ‹©æµ‹è¯•ç±»å‹ï¼š"
echo "  1) å¿«é€ŸéªŒè¯ï¼ˆçº¦10ç§’ï¼‰"
echo "  2) åŸºç¡€åŠŸèƒ½æµ‹è¯•ï¼ˆçº¦3åˆ†é’Ÿï¼‰"
echo "  3) é«˜çº§åŠŸèƒ½æµ‹è¯•ï¼ˆçº¦5åˆ†é’Ÿï¼‰"
echo "  4) å®Œæ•´æµ‹è¯•ï¼ˆçº¦8åˆ†é’Ÿï¼‰"
echo "  5) éªŒè¯é¢„ç®—æ•°æ®"
echo ""
read -p "è¯·è¾“å…¥é€‰æ‹© [1-5]: " choice

case $choice in
  1)
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "å¿«é€ŸéªŒè¯æµ‹è¯•"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "æµ‹è¯•1ï¼šè®°è´¦åŠŸèƒ½"
    curl -s -X POST http://localhost:8001/message \
      -H 'Content-Type: application/json' \
      -d '{"content": "æµ‹è¯•ï¼šä¹°èœ30å…ƒ", "user_id": "test_verify"}' | \
      python3 -c "import sys,json; r=json.load(sys.stdin); print('âœ“ å›å¤:', r['response'][:80])"
    echo ""
    
    echo "æµ‹è¯•2ï¼šé¢„ç®—æŸ¥è¯¢"
    curl -s -X POST http://localhost:8001/message \
      -H 'Content-Type: application/json' \
      -d '{"content": "è¿™ä¸ªæœˆé¢„ç®—è¿˜å‰©å¤šå°‘ï¼Ÿ", "user_id": "test_verify"}' | \
      python3 -c "import sys,json; r=json.load(sys.stdin); print('âœ“ å›å¤:', r['response'][:80])"
    echo ""
    echo "${GREEN}âœ… å¿«é€ŸéªŒè¯å®Œæˆï¼åŠŸèƒ½æ­£å¸¸ã€‚${NC}"
    ;;
    
  2)
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "åŸºç¡€åŠŸèƒ½æµ‹è¯•ï¼ˆçº¦3åˆ†é’Ÿï¼‰"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    docker-compose exec -T faa-api python examples/test_budget.py
    ;;
    
  3)
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "é«˜çº§åŠŸèƒ½æµ‹è¯•ï¼ˆçº¦5åˆ†é’Ÿï¼‰"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    docker-compose exec -T faa-api python examples/test_budget_advanced.py
    ;;
    
  4)
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "å®Œæ•´æµ‹è¯•å¥—ä»¶ï¼ˆçº¦8åˆ†é’Ÿï¼‰"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "${YELLOW}è¿è¡ŒåŸºç¡€åŠŸèƒ½æµ‹è¯•...${NC}"
    docker-compose exec -T faa-api python examples/test_budget.py
    echo ""
    echo "${YELLOW}è¿è¡Œé«˜çº§åŠŸèƒ½æµ‹è¯•...${NC}"
    docker-compose exec -T faa-api python examples/test_budget_advanced.py
    echo ""
    echo "${GREEN}âœ… å®Œæ•´æµ‹è¯•å¥—ä»¶æ‰§è¡Œå®Œæˆï¼${NC}"
    ;;
    
  5)
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "éªŒè¯é¢„ç®—æ•°æ®"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    docker-compose exec -T faa-api python -c "
import asyncio
from src.ai_engine import ai_engine
async def check():
    await ai_engine.initialize_mcp()
    result = await ai_engine._call_mcp_tool('search',
        query='', user_id='family_default',
        filters={'jsonb_equals': {'type': 'budget'}, 'limit': 10})
    
    budgets = [x for x in result if not x.get('_meta')]
    print(f'æ‰¾åˆ° {len(budgets)} ä¸ªé¢„ç®—è®°å½•ï¼š')
    print('')
    for b in budgets:
        aiu = b.get('ai_understanding', {})
        period = aiu.get('period')
        total = aiu.get('total_budget')
        cats = aiu.get('category_budgets', {})
        print(f'  â€¢ {period}: æ€»é¢„ç®— Â¥{total}')
        print(f'    ç±»ç›®æ•°ï¼š{len(cats)}')
    
    await ai_engine.close()
asyncio.run(check())
    "
    ;;
    
  *)
    echo "${YELLOW}æ— æ•ˆé€‰æ‹©ï¼Œé€€å‡º${NC}"
    exit 1
    ;;
esac

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "æµ‹è¯•å®Œæˆï¼"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“š ç›¸å…³æ–‡æ¡£ï¼š"
echo "  â€¢ å¿«é€Ÿå‚è€ƒï¼šBUDGET_QUICK_REFERENCE.md"
echo "  â€¢ åŠŸèƒ½æŒ‡å—ï¼šdocs/BUDGET_FEATURE_GUIDE.md"
echo "  â€¢ ä½¿ç”¨ç¤ºä¾‹ï¼šexamples/budget_usage_examples.md"
echo ""
