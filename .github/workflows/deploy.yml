name: Deploy FAA

on:
  push:
    branches: [main, master]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  PROJECT_PATH: /opt/family-ai-assistant

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: éƒ¨ç½²åˆ°æœåŠ¡å™¨
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || '22' }}
        script: |
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd ${{ env.PROJECT_PATH }}
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          echo "ðŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
          git pull origin main || git pull origin master
          
          # æ›´æ–°çŽ¯å¢ƒå˜é‡
          echo "âš™ï¸  æ›´æ–°é…ç½®..."
          cat > .env << 'EOF'
          # æ•°æ®åº“é…ç½®
          POSTGRES_USER=faa
          POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }}
          POSTGRES_DB=family_assistant
          
          # OpenAI
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          
          # Threema (å¯é€‰)
          THREEMA_GATEWAY_ID=${{ secrets.THREEMA_GATEWAY_ID }}
          THREEMA_API_SECRET=${{ secrets.THREEMA_API_SECRET }}
          
          # åº”ç”¨é…ç½®
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          APP_ENV=production
          LOG_LEVEL=INFO
          EOF
          
          # éƒ¨ç½²æœåŠ¡
          echo "ðŸš€ éƒ¨ç½²æœåŠ¡..."
          ./scripts/deploy.sh deploy
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼" 