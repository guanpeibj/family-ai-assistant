name: Deploy to Server

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Create deploy configuration
      run: |
        cat > deploy-config.json << 'EOF'
        {
          "timestamp": "${{ github.event.head_commit.timestamp }}",
          "commit": "${{ github.sha }}",
          "env": {
            "POSTGRES_PASSWORD": "${{ secrets.POSTGRES_PASSWORD }}",
            "DATABASE_URL": "postgresql://faa:${{ secrets.POSTGRES_PASSWORD }}@postgres:5432/family_assistant",
            "OPENAI_API_KEY": "${{ secrets.OPENAI_API_KEY }}",
            "OPENAI_MODEL": "gpt-4-turbo-preview",
            "THREEMA_GATEWAY_ID": "${{ secrets.THREEMA_GATEWAY_ID }}",
            "THREEMA_SECRET": "${{ secrets.THREEMA_SECRET }}",
            "THREEMA_PRIVATE_KEY": "${{ secrets.THREEMA_PRIVATE_KEY }}",
            "THREEMA_WEBHOOK_URL": "${{ secrets.THREEMA_WEBHOOK_URL }}",
            "SECRET_KEY": "${{ secrets.SECRET_KEY }}",
            "APP_ENV": "production",
            "LOG_LEVEL": "INFO"
          },
          "family_data": ${{ secrets.FAMILY_DATA_JSON }}
        }
        EOF
    
    - name: Commit deploy configuration
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add deploy-config.json
        git commit -m "ðŸš€ Deploy configuration - $(date)"
        git push
    
    - name: Deployment triggered
      run: |
        echo "âœ… éƒ¨ç½²é…ç½®å·²åˆ›å»ºå¹¶æŽ¨é€"
        echo "æœåŠ¡å™¨å°†åœ¨1åˆ†é’Ÿå†…è‡ªåŠ¨æ£€æµ‹å¹¶éƒ¨ç½²"
        echo "æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—: tail -f /var/log/faa.log"
