name: Deploy FAA

on:
  push:
    branches: [main, master]
  workflow_dispatch:  # 允许手动触发

env:
  PROJECT_PATH: /opt/family-ai-assistant

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 部署到服务器
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DEPLOY_HOST }}
        username: ${{ secrets.DEPLOY_USER }}
        key: ${{ secrets.DEPLOY_SSH_KEY }}
        port: ${{ secrets.DEPLOY_PORT || '22' }}
        script: |
          # 进入项目目录
          cd ${{ env.PROJECT_PATH }}
          
          # 拉取最新代码
          echo "📥 拉取最新代码..."
          git pull origin main || git pull origin master
          
          # 更新环境变量
          echo "⚙️  更新配置..."
          cat > .env << 'EOF'
          # 数据库配置
          POSTGRES_USER=faa
          POSTGRES_PASSWORD=${{ secrets.DB_PASSWORD }}
          POSTGRES_DB=family_assistant
          
          # OpenAI
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          
          # Threema (可选)
          THREEMA_GATEWAY_ID=${{ secrets.THREEMA_GATEWAY_ID }}
          THREEMA_API_SECRET=${{ secrets.THREEMA_API_SECRET }}
          
          # 应用配置
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          APP_ENV=production
          LOG_LEVEL=INFO
          EOF
          
          # 部署服务
          echo "🚀 部署服务..."
          ./scripts/deploy.sh deploy
          
          echo "✅ 部署完成！" 