# FAA (Family AI Assistant) ç³»ç»Ÿæ¶æ„æ–‡æ¡£

## ç‰ˆæœ¬ä¿¡æ¯
- **æ–‡æ¡£ç‰ˆæœ¬**: 2.0
- **æ›´æ–°æ—¥æœŸ**: 2025.09.29
- **AIå¼•æ“ç‰ˆæœ¬**: V2 Enhanced
- **Promptç‰ˆæœ¬**: v4.1

## ä¸€ã€ç³»ç»Ÿæ¦‚è§ˆ

### 1.1 æ ¸å¿ƒç†å¿µ
FAA éµå¾ªä¸‰ä¸ªæ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼š
1. **AIé©±åŠ¨ (AI-Driven)**: è®©AIå†³å®šä¸šåŠ¡é€»è¾‘ï¼Œå·¥ç¨‹åªæä¾›æ‰§è¡Œæ¡†æ¶
2. **å·¥ç¨‹ç®€åŒ– (Engineering Simplicity)**: ç»Ÿä¸€æµç¨‹ï¼Œæœ€å°åŒ–ä»£ç ï¼Œé€šè¿‡é…ç½®æ¼”è¿›
3. **ç¨³å®šå®ç° (Stable Implementation)**: å®Œå–„çš„é”™è¯¯å¤„ç†ã€æ—¥å¿—è¿½è¸ªå’Œé™çº§ç­–ç•¥

### 1.2 æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·äº¤äº’å±‚                            â”‚
â”‚     Threema â”‚ Web API â”‚ Email â”‚ Future Channels            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     FastAPI åº”ç”¨å±‚                           â”‚
â”‚  â€¢ /message ç«¯ç‚¹ï¼šç›´æ¥æ¶ˆæ¯å¤„ç†                               â”‚
â”‚  â€¢ /threema/webhookï¼šThreemaé›†æˆ                           â”‚
â”‚  â€¢ /media/getï¼šåª’ä½“æ–‡ä»¶è®¿é—®                                â”‚
â”‚  â€¢ /healthï¼šå¥åº·æ£€æŸ¥                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AIå¼•æ“ V2 (src/ai_engine.py)                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚                    ä¸»å¤„ç†æµç¨‹ (6æ­¥éª¤)                     â”‚ â”‚
â”‚ â”‚ 1. é¢„å¤„ç† (_preprocess_message)                         â”‚ â”‚
â”‚ â”‚ 2. å®éªŒç‰ˆæœ¬ (_get_experiment_version)                   â”‚ â”‚
â”‚ â”‚ 3. AIåˆ†æ (_analyze_message) ğŸ§  æ”¯æŒ3è½®æ€è€ƒå¾ªç¯         â”‚ â”‚
â”‚ â”‚ 4. æ¾„æ¸…å¤„ç† (_handle_clarification) å¯é€‰                â”‚ â”‚
â”‚ â”‚ 5. æ‰§è¡Œå“åº” (_execute_and_respond)                      â”‚ â”‚
â”‚ â”‚ 6. å®éªŒè®°å½• (_record_experiment_result)                 â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚                    æ ¸å¿ƒç»„ä»¶                              â”‚ â”‚
â”‚ â”‚ â€¢ ContextManager: æ™ºèƒ½ä¸Šä¸‹æ–‡ç®¡ç†                        â”‚ â”‚
â”‚ â”‚ â€¢ ToolExecutor: å·¥å…·ç¼–æ’æ‰§è¡Œ                           â”‚ â”‚
â”‚ â”‚ â€¢ MessageProcessor: æ¶ˆæ¯é¢„å¤„ç†                         â”‚ â”‚
â”‚ â”‚ â€¢ åµŒå…¥ç¼“å­˜: ä¸¤çº§ç¼“å­˜ä¼˜åŒ–                               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ HTTP
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          MCPå·¥å…·æœåŠ¡å™¨ (mcp-server/generic_mcp_server.py)    â”‚
â”‚  é€šç”¨å·¥å…·é›†ï¼ˆæ— ä¸šåŠ¡é€»è¾‘ï¼‰:                                   â”‚
â”‚  â€¢ store: å­˜å‚¨ä»»æ„ä¿¡æ¯                                      â”‚
â”‚  â€¢ search: è¯­ä¹‰/ç²¾ç¡®æœç´¢                                    â”‚
â”‚  â€¢ aggregate: æ•°æ®èšåˆç»Ÿè®¡                                  â”‚
â”‚  â€¢ schedule_reminder: æé†’ç®¡ç†                              â”‚
â”‚  â€¢ update_memory_fields: æ›´æ–°è®°å¿†                           â”‚
â”‚  â€¢ render_chart: å›¾è¡¨ç”Ÿæˆ                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PostgreSQL + pgvector                           â”‚
â”‚  â€¢ memories: æ ¸å¿ƒè®°å¿†è¡¨ (JSONB + Vector)                    â”‚
â”‚  â€¢ users: ç”¨æˆ·ç®¡ç†                                          â”‚
â”‚  â€¢ reminders: æé†’ä»»åŠ¡                                      â”‚
â”‚  â€¢ interactions: äº¤äº’è®°å½•                                   â”‚
â”‚  â€¢ households: å®¶åº­ç»“æ„                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## äºŒã€æ ¸å¿ƒå·¥ä½œæµ

### 2.1 æ¶ˆæ¯å¤„ç†æµç¨‹ (process_message)

```python
async def process_message(content: str, user_id: str, context: Dict) -> str:
    """
    ä¸»å…¥å£ - AIé©±åŠ¨çš„ç»Ÿä¸€æµç¨‹
    è€—æ—¶ç›®æ ‡: ç®€å•æ“ä½œ <5ç§’, æ™®é€šæŸ¥è¯¢ <10ç§’, å¤æ‚åˆ†æ <15ç§’
    """
    # æ­¥éª¤1: é¢„å¤„ç†
    # - åˆå¹¶é™„ä»¶æ–‡æœ¬(OCR/STT/Vision)
    # - æ—¥å¿—: step1.preprocess.completed
    
    # æ­¥éª¤2: è·å–å®éªŒç‰ˆæœ¬
    # - æ”¯æŒA/Bæµ‹è¯•ä¸åŒPrompt
    # - å½“å‰: v4_optimized (å¿«é€Ÿç‰ˆ)
    
    # æ­¥éª¤3: AIåˆ†æ (æ ¸å¿ƒ)
    # - æ”¯æŒå¤šè½®æ€è€ƒ(æœ€å¤š3è½®)
    # - æ™ºèƒ½è·å–æ‰€éœ€ä¸Šä¸‹æ–‡
    # - è¾“å‡ºç†è§£+å·¥å…·è®¡åˆ’
    
    # æ­¥éª¤4: æ¾„æ¸…å¤„ç† (å¯é€‰)
    # - ä»…åœ¨need_clarificationæ—¶
    
    # æ­¥éª¤5: æ‰§è¡Œå’Œå“åº”
    # - æ‰§è¡Œå·¥å…·è®¡åˆ’
    # - ç”Ÿæˆæœ€ç»ˆå“åº”
    
    # æ­¥éª¤6: å®éªŒè®°å½•
    # - è®°å½•A/Bæµ‹è¯•æ•°æ®
```

### 2.2 AIåˆ†æè¯¦è§£ (_analyze_message)

#### æ€è€ƒå¾ªç¯æœºåˆ¶
```
ç¬¬1è½®: åŸºç¡€ç†è§£
â”œâ”€â”€ è·å–åŸºç¡€ä¸Šä¸‹æ–‡ (æœ€è¿‘4æ¡å¯¹è¯ + å®¶åº­ä¿¡æ¯)
â”œâ”€â”€ æ„å»ºåˆ†æè½½è·
â”œâ”€â”€ è°ƒç”¨LLMåˆ†æ
â””â”€â”€ åˆ¤æ–­æ˜¯å¦éœ€è¦æ·±å…¥ (thinking_depth)

ç¬¬2-3è½®: æ·±åº¦åˆ†æ (å¯é€‰)
â”œâ”€â”€ åŸºäºåˆæ­¥ç†è§£è¯·æ±‚é¢å¤–ä¸Šä¸‹æ–‡
â”œâ”€â”€ ç´¯ç§¯æ´å¯Ÿ (accumulated_context)
â”œâ”€â”€ å†æ¬¡è°ƒç”¨LLMæ·±åŒ–ç†è§£
â””â”€â”€ è¾“å‡ºæœ€ç»ˆåˆ†æç»“æœ
```

#### è¾“å‡ºå¥‘çº¦ (AnalysisModel)
```json
{
  "understanding": {
    "intent": "ç”¨æˆ·æ„å›¾",
    "entities": {
      "amount": 100,
      "type": "è´­ç‰©"
    },
    "need_action": true,
    "need_clarification": false,
    "thinking_depth": 1,
    "needs_deeper_analysis": false,
    "original_content": "åŸå§‹æ¶ˆæ¯"
  },
  "context_requests": [
    {"name": "recent_memories", "kind": "recent_memories"}
  ],
  "tool_plan": {
    "steps": [
      {"tool": "store", "args": {...}}
    ]
  },
  "response_directives": {
    "profile": "compact"
  }
}
```

### 2.3 ä¸Šä¸‹æ–‡ç®¡ç† (ContextManager)

#### åŸºç¡€ä¸Šä¸‹æ–‡
- **light_context**: æœ€è¿‘å¯¹è¯è®°å½•
- **household**: å®¶åº­æˆå‘˜ä¿¡æ¯

#### åŠ¨æ€ä¸Šä¸‹æ–‡è¯·æ±‚
- **recent_memories**: å†å²è®°å¿†
- **semantic_search**: è¯­ä¹‰æœç´¢
- **direct_search**: ç²¾ç¡®è¿‡æ»¤
- **thread_summaries**: çº¿ç¨‹æ‘˜è¦

### 2.4 å·¥å…·æ‰§è¡Œ (ToolExecutor)

#### æ‰§è¡Œæµç¨‹
1. è·å–å·¥å…·å…ƒæ•°æ®
2. æ£€æŸ¥æ—¶é—´é¢„ç®—
3. æ‰§è¡Œå·¥å…·æ­¥éª¤
4. éªŒè¯ç»“æœå®Œæ•´æ€§
5. å¿…è¦æ—¶è¡¥å……æŸ¥è¯¢

#### éªŒè¯å¾ªç¯
- æœ€å¤š3è½®éªŒè¯
- æ£€æŸ¥æ•°æ®å®Œæ•´æ€§
- è‡ªåŠ¨è¡¥å……ç¼ºå¤±ä¿¡æ¯

## ä¸‰ã€å…³é”®æŠ€æœ¯ç‰¹æ€§

### 3.1 æ—¥å¿—ç³»ç»Ÿ

#### ä¸»æµç¨‹æ—¥å¿—
```
message.received           # æ¥æ”¶æ¶ˆæ¯
step1.preprocess.completed # é¢„å¤„ç†å®Œæˆ
step3.analysis.completed   # åˆ†æå®Œæˆ
step5.execution.completed  # æ‰§è¡Œå®Œæˆ
```

#### åˆ†æè¯¦ç»†æ—¥å¿—
```
analysis.round.started        # è½®æ¬¡å¼€å§‹
analysis.basic_context.details # ä¸Šä¸‹æ–‡è¯¦æƒ…
llm.response.summary          # LLMå“åº”
llm.understanding.details     # ç†è§£è¯¦æƒ…
llm.tool_plan.details        # å·¥å…·è®¡åˆ’
```

#### æ€§èƒ½è¿½è¸ª
- æ¯ä¸ªæ­¥éª¤éƒ½æœ‰ `duration_ms`
- æ”¯æŒ `trace_id` å…¨é“¾è·¯è¿½è¸ª
- å·¥å…·è°ƒç”¨è®¡æ•°å’Œè€—æ—¶

### 3.2 ç¼“å­˜æœºåˆ¶

#### å‘é‡åµŒå…¥ç¼“å­˜
- **Traceçº§ç¼“å­˜**: å•æ¬¡è¯·æ±‚å†…å¤ç”¨
- **å…¨å±€LRUç¼“å­˜**: è·¨è¯·æ±‚å¤ç”¨
- **TTL**: 3600ç§’
- **å®¹é‡**: 1000é¡¹

#### å·¥å…·å…ƒæ•°æ®ç¼“å­˜
- ç¼“å­˜MCPå·¥å…·åˆ—è¡¨
- å‡å°‘HTTPè°ƒç”¨

### 3.3 Promptç®¡ç†

#### ç‰ˆæœ¬ä½“ç³»
```yaml
current: "v4_optimized"  # å½“å‰æ¿€æ´»ç‰ˆæœ¬

prompts:
  v4_default:    # å®Œæ•´åˆ†æç‰ˆ
    - æ”¯æŒ3è½®æ€è€ƒ
    - å…¨é¢ä¸Šä¸‹æ–‡
    - è¯¦ç»†å“åº”
    
  v4_optimized:  # å¿«é€Ÿå“åº”ç‰ˆ(æ¨è)
    - é™åˆ¶1è½®æ€è€ƒ
    - æœ€å°‘ä¸Šä¸‹æ–‡
    - ç®€æ´å›å¤
```

#### åŠ¨æ€æ³¨å…¥
- `{{DYNAMIC_TOOLS}}`: å·¥å…·åˆ—è¡¨
- `{{DYNAMIC_TOOL_SPECS}}`: å·¥å…·è§„æ ¼

### 3.4 é”™è¯¯å¤„ç†

#### å¼‚å¸¸å±‚çº§
```
BaseAIException
â”œâ”€â”€ AnalysisError       # AIåˆ†æå¤±è´¥
â”œâ”€â”€ ContextResolutionError # ä¸Šä¸‹æ–‡å¤±è´¥
â”œâ”€â”€ ToolPlanningError   # è§„åˆ’å¤±è´¥
â”œâ”€â”€ MCPToolError        # å·¥å…·è°ƒç”¨å¤±è´¥
â”œâ”€â”€ ToolTimeoutError    # å·¥å…·è¶…æ—¶
â””â”€â”€ LLMError           # LLMè°ƒç”¨å¤±è´¥
```

#### é™çº§ç­–ç•¥
1. å·¥å…·å¤±è´¥ â†’ åŸºç¡€å“åº”
2. LLMå¤±è´¥ â†’ å‹å¥½æç¤º
3. ä¸¥é‡é”™è¯¯ â†’ è¯¦ç»†æ—¥å¿—

## å››ã€æ•°æ®æ¨¡å‹

### 4.1 æ ¸å¿ƒè¡¨ç»“æ„

#### memories (æ ¸å¿ƒè®°å¿†è¡¨)
```sql
CREATE TABLE memories (
    id UUID PRIMARY KEY,
    user_id UUID NOT NULL,
    content TEXT NOT NULL,
    ai_understanding JSONB,    -- AIè‡ªç”±å­˜å‚¨
    embedding vector(1536),     -- è¯­ä¹‰å‘é‡
    amount DECIMAL(10,2),       -- é‡‘é¢(å¯é€‰)
    occurred_at TIMESTAMP,      -- å‘ç”Ÿæ—¶é—´
    created_at TIMESTAMP DEFAULT NOW()
);
```

#### ç´¢å¼•ç­–ç•¥
- å‘é‡ç´¢å¼•: `ivfflat`
- JSONBç´¢å¼•: `jsonb_path_ops`
- è¡¨è¾¾å¼ç´¢å¼•: `thread_id`, `type`, `channel`
- ç»„åˆç´¢å¼•: æ—¶é—´+ç”¨æˆ·

### 4.2 JSONBçµæ´»æ€§

AIå¯ä»¥åœ¨ `ai_understanding` ä¸­å­˜å‚¨ä»»æ„ç»“æ„:
```json
{
  "type": "expense",
  "amount": 100,
  "category": "è´­ç‰©",
  "thread_id": "20250929",
  "entities": {
    "shop": "è¶…å¸‚",
    "items": ["ç‰›å¥¶", "é¢åŒ…"]
  },
  // AIå¯ä»¥è‡ªç”±æ‰©å±•...
  "confidence": 0.95,
  "related_memories": ["uuid1", "uuid2"]
}
```

## äº”ã€æ€§èƒ½ä¼˜åŒ–

### 5.1 ç›®æ ‡æŒ‡æ ‡
| æ“ä½œç±»å‹ | ç›®æ ‡è€—æ—¶ | å½“å‰è€—æ—¶ |
|---------|---------|---------|
| ç®€å•è®°å½• | <5ç§’ | 5-8ç§’ |
| æ™®é€šæŸ¥è¯¢ | <10ç§’ | 10-12ç§’ |
| å¤æ‚åˆ†æ | <15ç§’ | 15-18ç§’ |
| æ€è€ƒè½®æ•° | â‰¤2è½® | 1-2è½® |

### 5.2 ä¼˜åŒ–ç­–ç•¥

#### å·²å®æ–½
- âœ… Promptä¼˜åŒ– (v4_optimized)
- âœ… å‘é‡åµŒå…¥ç¼“å­˜
- âœ… å‡å°‘æ€è€ƒè½®æ•°
- âœ… ç®€åŒ–ä¸Šä¸‹æ–‡è¯·æ±‚

#### è®¡åˆ’ä¸­
- [ ] æŸ¥è¯¢ç»“æœç¼“å­˜
- [ ] å·¥å…·å¹¶è¡Œæ‰§è¡Œ
- [ ] æµå¼å“åº”
- [ ] é¢„ç¼–è¯‘Prompt

### 5.3 ç›‘æ§è¦ç‚¹
```python
# å…³é”®ç›‘æ§æŒ‡æ ‡
{
  "thinking_rounds": 1-2,      # æ€è€ƒè½®æ•°
  "tool_calls": 1-3,           # å·¥å…·è°ƒç”¨æ•°
  "total_duration_ms": <15000, # æ€»è€—æ—¶
  "cache_hit_rate": >0.5       # ç¼“å­˜å‘½ä¸­ç‡
}
```

## å…­ã€éƒ¨ç½²æ¶æ„

### 6.1 å®¹å™¨åŒ–éƒ¨ç½²
```yaml
services:
  faa-api:       # FastAPIåº”ç”¨
    - AIå¼•æ“
    - APIç«¯ç‚¹
    - åå°ä»»åŠ¡
    
  faa-mcp:       # MCPå·¥å…·æœåŠ¡
    - HTTPåŒ…è£…å™¨
    - é€šç”¨å·¥å…·é›†
    
  faa-postgres:  # æ•°æ®åº“
    - PostgreSQL 15
    - pgvectoræ‰©å±•
```

### 6.2 ç¯å¢ƒé…ç½®

#### æ ¸å¿ƒé…ç½®
```bash
# AIé…ç½®
OPENAI_API_KEY=xxx
OPENAI_MODEL=gpt-4
AI_PROVIDER=openai

# ç³»ç»Ÿé…ç½®
DEBUG=false
LOW_BUDGET_MODE=false
MCP_SERVER_URL=http://faa-mcp:8000

# æ•°æ®åº“
DATABASE_URL=postgresql://...
```

## ä¸ƒã€å¼€å‘æŒ‡å—

### 7.1 æ·»åŠ æ–°åŠŸèƒ½ï¼ˆæ— éœ€æ”¹ä»£ç ï¼‰

#### æ–¹æ³•1: ä¿®æ”¹Prompt
```yaml
# prompts/family_assistant_prompts.yaml
blocks:
  my_new_feature: |
    æ–°åŠŸèƒ½çš„è¡Œä¸ºæè¿°...

prompts:
  v4_optimized:
    understanding_blocks:
      - my_new_feature  # æ·»åŠ åˆ°å—åˆ—è¡¨
```

#### æ–¹æ³•2: è°ƒæ•´å·¥å…·ä½¿ç”¨
é€šè¿‡Promptå¼•å¯¼AIä½¿ç”¨ç°æœ‰å·¥å…·çš„æ–°ç»„åˆ

### 7.2 æ·»åŠ æ–°å·¥å…·

1. åœ¨MCPæœåŠ¡å™¨æ·»åŠ å·¥å…·:
```python
# mcp-server/generic_mcp_server.py
async def _new_tool(self, ...):
    """ä¿æŒé€šç”¨æ€§ï¼Œæ— ä¸šåŠ¡é€»è¾‘"""
    pass
```

2. æ›´æ–°å·¥å…·ç™½åå•ï¼ˆå¦‚éœ€è¦ï¼‰

### 7.3 è°ƒè¯•æŠ€å·§

#### æ—¥å¿—è°ƒè¯•
```bash
# å¼€å¯è°ƒè¯•æ¨¡å¼
DEBUG=true

# å…³é”®æ—¥å¿—ç‚¹
grep "step3.analysis" logs.txt    # åˆ†æè¿‡ç¨‹
grep "trace_id=xxx" logs.txt      # è¿½è¸ªè¯·æ±‚
grep "duration_ms" logs.txt       # æ€§èƒ½åˆ†æ
```

#### æ€§èƒ½åˆ†æ
```python
# æŸ¥çœ‹å„æ­¥éª¤è€—æ—¶
"step1.preprocess.completed" duration_ms=10
"step3.analysis.completed" duration_ms=8000
"step5.execution.completed" duration_ms=3000
```

## å…«ã€æœ€ä½³å®è·µ

### 8.1 Promptä¼˜åŒ–
- ä½¿ç”¨ v4_optimized ç‰ˆæœ¬
- é™åˆ¶æ€è€ƒæ·±åº¦ä¸º0-1
- å‡å°‘ä¸å¿…è¦çš„ä¸Šä¸‹æ–‡è¯·æ±‚
- ä½¿ç”¨èšåˆå·¥å…·æ›¿ä»£å¤šæ¬¡æŸ¥è¯¢

### 8.2 å·¥å…·ä½¿ç”¨
- ç›´æ¥æ‰§è¡Œï¼Œé¿å…é¢„æ£€æŸ¥
- ä½¿ç”¨ç²¾ç¡®è¿‡æ»¤æ¡ä»¶
- æ‰¹é‡æ“ä½œä¼˜äºé€ä¸ªå¤„ç†

### 8.3 é”™è¯¯å¤„ç†
- æä¾›å‹å¥½çš„ç”¨æˆ·æç¤º
- è®°å½•è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
- å®æ–½åˆç†çš„é™çº§ç­–ç•¥

## ä¹ã€è·¯çº¿å›¾

### 2025 Q1 (å·²å®Œæˆ)
- âœ… AIå¼•æ“V2é‡æ„
- âœ… æ€è€ƒå¾ªç¯ä¼˜åŒ–
- âœ… è¯¦ç»†æ—¥å¿—ç³»ç»Ÿ
- âœ… Prompt v4ä¼˜åŒ–

### 2025 Q2 (è¿›è¡Œä¸­)
- [ ] æŸ¥è¯¢ç»“æœç¼“å­˜
- [ ] å·¥å…·å¹¶è¡ŒåŒ–
- [ ] æµå¼å“åº”
- [ ] æ€§èƒ½ç›‘æ§é¢æ¿

### 2025 Q3-Q4
- [ ] å¤šæ¨¡æ€å¢å¼º
- [ ] è‡ªé€‚åº”Prompt
- [ ] åˆ†å¸ƒå¼æ‰§è¡Œ
- [ ] æ™ºèƒ½é¢„åŠ è½½

## åã€å‚è€ƒæ–‡æ¡£

- [AIå¼•æ“å·¥ä½œæµ](.cursor/rules/01-ai-engine.mdc)
- [Promptç®¡ç†](.cursor/rules/02-prompts.mdc)
- [MCPå·¥å…·å¼€å‘](.cursor/rules/03-mcp-tools.mdc)
- [æ•°æ®åº“è®¾è®¡](.cursor/rules/05-database-and-index.mdc)
- [éƒ¨ç½²æŒ‡å—](DEPLOY.md)

---
*Architecture Version: 2.0*
*Last Updated: 2025.09.29*
*Maintained by: AI-Driven Development Team*