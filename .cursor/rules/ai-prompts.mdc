---
globs: src/ai_engine.py,*prompt*,**/prompts/*,data/**
---
# AI 提示词工程规则 v2（已对齐日历/隐私/多渠道约束）

## 核心目标
- 赋能 AI 自主决策，代码不变即可通过 Prompt/数据演化获得更强能力
- 对齐 FAA 核心理念：开放式数据结构、工具通用、动态适配、多渠道友好

## Prompt 结构与版本管理（blocks + inherits + vars + overrides）
- YAML 采用 blocks + inherits + vars
- 支持 profiles/overrides（按 channel/user/场景）覆写语气、长度、格式
- 动态注入工具：{{DYNAMIC_TOOLS}} / {{DYNAMIC_TOOL_SPECS}}，工具获取失败时给出“回退策略指引”（例如：仅基于 filters 执行 search/aggregate 的降级路径）

## 信息完整性与澄清策略 2.0
- 记账/健康/提醒/更新：缺失关键字段时 `need_clarification=true`
- 一次只问一个问题；优先提供候选项；利用同线程上下文缩小范围
- 输出 JSON 严格遵守最小字段集合：intent/entities/need_action/need_clarification/missing_fields/clarification_questions/suggested_actions/original_content/context_related/occurred_at

## 时间与日历解析（calendar_event）
- 统一时区（vars.timezone），所有时间使用 ISO
- 节假日/学期/家庭日程：优先检索 `type=calendar_event` 的 memory（按 date_from/date_to/person/tags/category 过滤）
- 对“这个月/上周X/国庆/开学日”等自然语言做日期落地，必要时先澄清

## 多模态
- 附件衍生文本（transcription/ocr/vision）优先用于理解
- 同一 `thread_id` 的多轮补充合并理解；信息不足先问再行动

## 工具编排 DSL v2（文案层约定，鼓励幂等）
- 仅输出 JSON：{"steps":[{"tool":string,"args":object}]}
- 存储：合并 entities 到 ai_data；包含 occurred_at/thread_id/tags；建议附加 external_id/source/version，以便通过 search(jsonb_equals) 实现软去重/软更新
- 搜索/聚合：明确 filters（date_from/date_to/person/category/tags/group_by/group_by_ai_field）
- 无需动作：返回 {"steps":[]}

## 输出规范与长度
- 渠道长度/表情/表格约束由 profiles/overrides 控制
- 正常回复：先说明操作结果，再列要点；澄清回复：先确认已理解，再提出关键问题

## 隐私与敏感信息（privacy_policy）
- 不主动回显敏感信息（如 Wi-Fi 密码/钥匙位置），除非用户明确请求
- 回答敏感内容时，先提示隐私风险与确认

## A/B 测试与评估
- 版本示例：v3_compact（更短回复）、v3_helpful（更详细建议）
- 指标：理解准确度、澄清有效率、回复长度分布、追问率、工具调用成功率

## 建议的 YAML 增补块（示意，已补充到 v2_enhanced）
- privacy_policy
- calendar_parsing_rules
- channel_overrides
- length_constraints
- uncertainty_handling