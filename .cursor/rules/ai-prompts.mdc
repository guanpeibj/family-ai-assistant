---
globs: src/ai_engine.py,*prompt*,**/prompts/*,data/**
---
# AI 提示词工程规则 v4（单次分析契约 + Profile 覆写）

## 核心目标
- 赋能 AI 自主决策，代码不变即可通过 Prompt/数据演化获得更强能力
- 对齐 FAA 核心理念：开放式数据结构、工具通用、动态适配、多渠道友好

## Prompt 结构与版本管理（blocks + profiles + vars）
- YAML 采用 blocks 拼装核心段落（system/understanding/response/tool_planning/ack）
- Profiles 覆写按渠道语气与长度（例如 `threema` 使用 `response_voice_compact`）
- 动态工具注入：{{DYNAMIC_TOOLS}} / {{DYNAMIC_TOOL_SPECS}}，按需呈现即可，无需硬编码降级逻辑

## 单次分析契约
- 输出 JSON = {`understanding`, `context_requests`, `tool_plan`, `response_directives`}
- `understanding` 至少包含 intent / entities / need_action / need_clarification / missing_fields / clarification_questions / suggested_reply / occurred_at
- `context_requests` 列表声明需要引擎补齐的资源（recent_memories / semantic_search / direct_search / thread_summaries）
- `tool_plan` 可先给草稿步骤，`requires_context` 指示等上下文满足后再由二次计划补全
- `response_directives.profile` 驱动回复风格（default/compact/detailed），其余键可传 tone / focus_points 等提示

## 时间与日历解析（calendar_event）
- 统一时区（vars.timezone），所有时间使用 ISO
- 节假日/学期/家庭日程：优先检索 `type=calendar_event` 的 memory（按 date_from/date_to/person/tags/category 过滤）
- 对“这个月/上周X/国庆/开学日”等自然语言做日期落地，必要时先澄清

## 多模态
- 附件衍生文本（transcription/ocr/vision）优先用于理解
- 同一 `thread_id` 的多轮补充合并理解；信息不足先问再行动

## 工具编排 DSL
- 仅输出 JSON：{"steps":[{"tool":string,"args":object}],"requires_context":[]}
- 引用上下文：使用 {"use_context": "semantic_expenses", "path": "0.id"}
- 存储类：将 understanding.entities 合并进 ai_data，补齐 occurred_at/thread_id/trace_id
- 查询/聚合：显式 filters，允许 `filters.scope` / `filters.person_ids`
- 无需动作：返回空 steps 并在 requires_context 写原因

## 回复规范
- 使用 `response_directives.profile` 控制长度与语气，默认 profile = default，Threema = compact
- 澄清：复述已知信息，一次只问一个问题，可提供候选项
- 正常回复：引用工具返回的真实数据，缺数据时诚实说明并建议下一步

## 隐私与敏感信息（privacy_policy）
- 不主动回显敏感信息（如 Wi-Fi 密码/钥匙位置），除非用户明确请求
- 回答敏感内容时，先提示隐私风险与确认

## A/B 测试与评估
- 可以通过新增 profile（如 `v4_detailed`）或覆写 `response_directives` 策略做实验
- 指标：理解准确度、澄清命中率、上下文请求命中率、工具调用成功率、回复长度分布

## 建议的 YAML 增补块
- understanding_contract（定义 JSON 契约）
- planning_brief（约束工具编排）
- response_voice_default / response_voice_compact（差异化语气）
- ack_prompt（确认模板）
