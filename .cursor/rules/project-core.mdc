---
globs: ["src/**", "prompts/**", "mcp-server/**"]
description: FAAé¡¹ç›®æ ¸å¿ƒç†å¿µä¸æœ€æ–°å·¥ä½œæµ
---

# FAA (Family AI Assistant) é¡¹ç›®æ ¸å¿ƒç†å¿µ v2

## ä¸‰ä¸ªæ ¸å¿ƒåŸåˆ™ ğŸ¯

### 1. AIé©±åŠ¨ (AI-Driven)
- **è®©AIå†³å®šä¸€åˆ‡ä¸šåŠ¡é€»è¾‘**ï¼šä¸ç¡¬ç¼–ç è§„åˆ™ï¼Œé€šè¿‡Promptå¼•å¯¼è¡Œä¸º
- **å¼€æ”¾æ•°æ®ç»“æ„**ï¼šJSONBè®©AIè‡ªç”±å­˜å‚¨å’Œæ‰©å±•ä¿¡æ¯
- **å·¥å…·é€šç”¨åŒ–**ï¼šMCPå·¥å…·æ— ä¸šåŠ¡é€»è¾‘ï¼Œç”¨é€”ç”±AIå†³å®š

### 2. å·¥ç¨‹ç®€åŒ– (Engineering Simplicity)
- **ç»Ÿä¸€å¤„ç†æµç¨‹**ï¼š6æ­¥éª¤æ ‡å‡†æµç¨‹ï¼Œæ¸…æ™°å¯è¿½è¸ª
- **æœ€å°åŒ–ä»£ç **ï¼šåŠŸèƒ½é€šè¿‡Promptå’Œæ•°æ®æ¼”è¿›ï¼Œä¸æ”¹ä»£ç 
- **ç»„ä»¶è§£è€¦**ï¼šAIå¼•æ“ã€MCPå·¥å…·ã€APIå±‚å„å¸å…¶èŒ

### 3. ç¨³å®šå®ç° (Stable Implementation)
- **å®Œå–„é”™è¯¯å¤„ç†**ï¼šå¤šçº§å¼‚å¸¸æ•è·å’Œå‹å¥½æç¤º
- **è¯¦ç»†æ—¥å¿—è¿½è¸ª**ï¼šæ¯æ­¥éƒ½æœ‰æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•
- **é™çº§ç­–ç•¥**ï¼šå·¥å…·å¤±è´¥æœ‰fallbackï¼Œç³»ç»Ÿä¿æŒå¯ç”¨

## æœ€æ–°æ¶æ„ (2025.09)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·äº¤äº’å±‚                           â”‚
â”‚  Threema â”‚ API â”‚ Email â”‚ Future Channels                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   AIå¼•æ“ V2 (æ ¸å¿ƒ)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1.é¢„å¤„ç† â†’ 2.ç‰ˆæœ¬é€‰æ‹© â†’ 3.AIåˆ†æ(æ€è€ƒå¾ªç¯)      â”‚   â”‚
â”‚  â”‚ 4.æ¾„æ¸…? â†’ 5.æ‰§è¡Œ&å“åº” â†’ 6.å®éªŒè®°å½•              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â€¢ ContextManager: æ™ºèƒ½ä¸Šä¸‹æ–‡è·å–                       â”‚
â”‚  â€¢ ToolExecutor: å·¥å…·ç¼–æ’æ‰§è¡Œ                          â”‚
â”‚  â€¢ åµŒå…¥ç¼“å­˜: ä¸¤çº§ä¼˜åŒ–                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              MCPå·¥å…·æœåŠ¡å™¨ (é€šç”¨èƒ½åŠ›)                    â”‚
â”‚  store â”‚ search â”‚ aggregate â”‚ schedule_reminder â”‚ ...   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   PostgreSQL + pgvector                  â”‚
â”‚  memories â”‚ users â”‚ reminders â”‚ interactions            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å·¥ä½œæµè¯¦è§£ (ai_engine.py)

### æ¶ˆæ¯å¤„ç†ä¸»æµç¨‹
```python
async def process_message(content, user_id, context) -> str:
    # æ­¥éª¤1: é¢„å¤„ç†ï¼ˆåˆå¹¶é™„ä»¶æ–‡æœ¬ï¼‰
    # æ­¥éª¤2: è·å–å®éªŒç‰ˆæœ¬ï¼ˆA/Bæµ‹è¯•ï¼‰
    # æ­¥éª¤3: AIåˆ†æï¼ˆæ ¸å¿ƒï¼Œæ”¯æŒ3è½®æ€è€ƒï¼‰
    # æ­¥éª¤4: å¤„ç†æ¾„æ¸…ï¼ˆå¦‚éœ€è¦ï¼‰
    # æ­¥éª¤5: æ‰§è¡Œå·¥å…·å¹¶ç”Ÿæˆå“åº”
    # æ­¥éª¤6: è®°å½•å®éªŒç»“æœ
```

### AIåˆ†ææ ¸å¿ƒï¼ˆæ€è€ƒå¾ªç¯ï¼‰
```python
async def _analyze_message(...) -> AnalysisModel:
    for round in range(1, 4):  # æœ€å¤š3è½®
        # è·å–ä¸Šä¸‹æ–‡ï¼ˆç¬¬1è½®åŸºç¡€ï¼Œåç»­ç´¯ç§¯ï¼‰
        # è°ƒç”¨LLMåˆ†æ
        # åˆ¤æ–­æ˜¯å¦éœ€è¦æ·±å…¥ï¼ˆthinking_depthï¼‰
        # å¿…è¦æ—¶è·å–é¢å¤–ä¸Šä¸‹æ–‡ç»§ç»­
```

### å…³é”®æ—¥å¿—ç‚¹ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
- `step1-6`: ä¸»æµç¨‹å„æ­¥éª¤
- `analysis.round`: æ€è€ƒè½®æ¬¡
- `llm.response`: LLMè°ƒç”¨è¯¦æƒ…
- `context.*`: ä¸Šä¸‹æ–‡è·å–
- `mcp.tool.*`: å·¥å…·æ‰§è¡Œ

## Promptç®¡ç† (v4.1)

### ç‰ˆæœ¬ç­–ç•¥
- **v4_default**: å®Œæ•´åˆ†æç‰ˆï¼ˆæ·±åº¦æ€è€ƒï¼‰
- **v4_optimized**: å¿«é€Ÿå“åº”ç‰ˆï¼ˆæ¨èç”Ÿäº§ï¼‰

### ä¼˜åŒ–è¦ç‚¹
```yaml
understanding_contract_optimized:
  thinking_depth: 0|1  # é™åˆ¶æ€è€ƒæ·±åº¦
  needs_deeper_analysis: false  # é»˜è®¤ä¸æ·±å…¥
  context_requests: []  # æœ€å°‘ä¸Šä¸‹æ–‡
  response_directives:
    profile: "compact"  # ç®€æ´å›å¤
```

## æ€§èƒ½æŒ‡æ ‡

### ç›®æ ‡å€¼
- ç®€å•è®°å½•: < 5ç§’
- æ™®é€šæŸ¥è¯¢: < 10ç§’
- å¤æ‚åˆ†æ: < 15ç§’
- æ€è€ƒè½®æ•°: â‰¤ 2è½®

### ä¼˜åŒ–æ–¹å‘
1. **Promptä¼˜åŒ–**: å‡å°‘æ€è€ƒè½®æ•°
2. **ç¼“å­˜ç­–ç•¥**: å‘é‡åµŒå…¥ã€æŸ¥è¯¢ç»“æœ
3. **å¹¶è¡Œæ‰§è¡Œ**: ç‹¬ç«‹å·¥å…·å¹¶å‘
4. **èšåˆæŸ¥è¯¢**: ä¸€æ¬¡æŸ¥è¯¢æ›¿ä»£å¤šæ¬¡

## å¼€å‘æŒ‡å—

### æ·»åŠ æ–°åŠŸèƒ½ï¼ˆæ— éœ€æ”¹ä»£ç ï¼‰
1. ä¿®æ”¹ `prompts/family_assistant_prompts.yaml`
2. æ·»åŠ æ–°çš„blocksæˆ–è°ƒæ•´ç°æœ‰blocks
3. åˆ‡æ¢currentç‰ˆæœ¬æµ‹è¯•

### æ·»åŠ æ–°å·¥å…·
1. åœ¨ `mcp-server/generic_mcp_server.py` æ·»åŠ 
2. ä¿æŒé€šç”¨æ€§ï¼Œä¸å«ä¸šåŠ¡é€»è¾‘
3. æ›´æ–°å·¥å…·ç™½åå•ï¼ˆå¦‚éœ€è¦ï¼‰

### è°ƒè¯•æŠ€å·§
1. è®¾ç½® `DEBUG=true` æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
2. å…³æ³¨ `trace_id` è¿½è¸ªå®Œæ•´æµç¨‹
3. æŸ¥çœ‹ `duration_ms` æ‰¾æ€§èƒ½ç“¶é¢ˆ

## æ¼”è¿›è·¯çº¿

### çŸ­æœŸï¼ˆ2025 Q1ï¼‰
- âœ… æ€è€ƒå¾ªç¯ä¼˜åŒ–
- âœ… è¯¦ç»†æ—¥å¿—è¿½è¸ª
- âœ… Promptå¿«é€Ÿç‰ˆæœ¬
- [ ] æŸ¥è¯¢ç»“æœç¼“å­˜

### ä¸­æœŸï¼ˆ2025 Q2ï¼‰
- [ ] æµå¼å“åº”
- [ ] å·¥å…·å¹¶è¡ŒåŒ–
- [ ] æ™ºèƒ½é¢„åŠ è½½

### é•¿æœŸï¼ˆ2025 Q3+ï¼‰
- [ ] å¤šæ¨¡æ€ç†è§£å¢å¼º
- [ ] è‡ªé€‚åº”Prompté€‰æ‹©
- [ ] åˆ†å¸ƒå¼å·¥å…·æ‰§è¡Œ

## å…³é”®æ–‡ä»¶æ˜ å°„

```
src/ai_engine.py          # æ ¸å¿ƒå¼•æ“ï¼ˆæœ¬æ–‡æ¡£é‡ç‚¹ï¼‰
â”œâ”€â”€ process_message()     # ä¸»å…¥å£
â”œâ”€â”€ _analyze_message()    # AIåˆ†æ
â”œâ”€â”€ ContextManager        # ä¸Šä¸‹æ–‡ç®¡ç†
â””â”€â”€ ToolExecutor         # å·¥å…·æ‰§è¡Œ

prompts/family_assistant_prompts.yaml  # Prompté…ç½®
â”œâ”€â”€ v4_default           # é»˜è®¤ç‰ˆæœ¬
â””â”€â”€ v4_optimized        # ä¼˜åŒ–ç‰ˆæœ¬

mcp-server/generic_mcp_server.py  # MCPå·¥å…·
â”œâ”€â”€ store()             # å­˜å‚¨
â”œâ”€â”€ search()            # æœç´¢
â””â”€â”€ aggregate()         # èšåˆ
```

## é‡è¦çº¦å®š

### æ•°æ®æµå‘
```
ç”¨æˆ·è¾“å…¥ â†’ AIç†è§£ â†’ å·¥å…·æ‰§è¡Œ â†’ å“åº”ç”Ÿæˆ
         â†“         â†“         â†“
     (Prompt)   (MCP)    (Prompt)
```

### å†³ç­–æƒå½’å±
- **AIå†³å®š**: æ„å›¾ç†è§£ã€å·¥å…·é€‰æ‹©ã€å“åº”å†…å®¹
- **å·¥ç¨‹æä¾›**: æ‰§è¡Œæ¡†æ¶ã€å·¥å…·èƒ½åŠ›ã€æ•°æ®å­˜å‚¨
- **Promptæ§åˆ¶**: è¡Œä¸ºè§„èŒƒã€é£æ ¼æŒ‡å¼•ã€èƒ½åŠ›è¾¹ç•Œ

### é”™è¯¯å¤„ç†
1. å·¥å…·å¤±è´¥ â†’ é™çº§åˆ°åŸºç¡€å“åº”
2. LLMå¤±è´¥ â†’ è¿”å›å‹å¥½æç¤º
3. ä¸¥é‡é”™è¯¯ â†’ è®°å½•æ—¥å¿—å¹¶é€šçŸ¥

## ç›‘æ§è¦ç‚¹

### å…³é”®æŒ‡æ ‡
- `thinking_rounds`: æ€è€ƒè½®æ•°ï¼ˆåº”â‰¤2ï¼‰
- `tool_calls_count`: å·¥å…·è°ƒç”¨æ•°
- `duration_ms`: å„æ­¥éª¤è€—æ—¶
- `cache_hit_rate`: ç¼“å­˜å‘½ä¸­ç‡

### å‘Šè­¦é˜ˆå€¼
- å“åº”æ—¶é—´ > 20ç§’
- æ€è€ƒè½®æ•° > 3è½®
- å·¥å…·å¤±è´¥ç‡ > 10%
- é”™è¯¯ç‡ > 5%

---
*Last Updated: 2025.09.29*
*Version: 2.0*
*AI Engine: V2 Enhanced*