---
globs: src/ai_engine.py
description: AIå¼•æ“V2å¢å¼ºç‰ˆå·¥ä½œæµ - æ™ºèƒ½æ€è€ƒå¾ªç¯ä¸è¯¦ç»†æ—¥å¿—è¿½è¸ª
---

## æ ¸å¿ƒæ¶æ„
**ç‰ˆæœ¬**: AIEngineV2 å¢å¼ºç‰ˆ
**ç†å¿µ**: AIé©±åŠ¨å†³ç­–ã€å·¥ç¨‹æä¾›æ¡†æ¶ã€èƒ½åŠ›è‡ªåŠ¨è¿›åŒ–

```
ç”¨æˆ·è¾“å…¥ â†’ é¢„å¤„ç† â†’ [æ€è€ƒå¾ªç¯] AIåˆ†æ â†’ å·¥å…·æ‰§è¡Œ â†’ å“åº”ç”Ÿæˆ â†’ æŒä¹…åŒ–
```

## ä¸»æµç¨‹ `process_message` (6æ­¥éª¤)

### æ­¥éª¤1: æ¶ˆæ¯é¢„å¤„ç† (`_preprocess_message`)
- åˆå¹¶é™„ä»¶è¡ç”Ÿæ–‡æœ¬ï¼ˆOCR/STT/Visionï¼‰
- æ—¥å¿—: `step1.preprocess.completed`
- è€—æ—¶è¿½è¸ª: `duration_ms`

### æ­¥éª¤2: å®éªŒç‰ˆæœ¬é€‰æ‹© (`_get_experiment_version`)
- æ”¯æŒA/Bæµ‹è¯•ä¸åŒPromptç‰ˆæœ¬
- å½“å‰é»˜è®¤: `v4_optimized`ï¼ˆå¿«é€Ÿå“åº”ï¼‰
- æ—¥å¿—: `step2.experiment.version`

### æ­¥éª¤3: AIç†è§£åˆ†æ (`_analyze_message`) ğŸ§ æ ¸å¿ƒ
**å¤šè½®æ€è€ƒå¾ªç¯ï¼ˆæœ€å¤š3è½®ï¼‰**ï¼š

#### ç¬¬1è½® - åŸºç¡€ç†è§£
1. è·å–åŸºç¡€ä¸Šä¸‹æ–‡:
   - æœ€è¿‘4æ¡å¯¹è¯è®°å½• (`light_context`)
   - å®¶åº­æˆå‘˜ä¿¡æ¯ (`household`)
   - æ—¥å¿—: `analysis.basic_context.details`

2. æ„å»ºåˆ†æè½½è·å¹¶è°ƒç”¨LLM:
   - æ—¥å¿—: `analysis.payload.summary`
   - LLMå“åº”: `llm.response.summary` (å«è€—æ—¶)
   - ç†è§£è¯¦æƒ…: `llm.understanding.details`
   - å·¥å…·è®¡åˆ’: `llm.tool_plan.details`

3. åˆ¤æ–­æ˜¯å¦éœ€è¦æ·±å…¥åˆ†æ:
   - `thinking_depth`: 0-3çº§å¤æ‚åº¦
   - `needs_deeper_analysis`: æ˜¯å¦éœ€è¦æ›´å¤šè½®æ¬¡

#### ç¬¬2-3è½® - æ·±åº¦åˆ†æï¼ˆæŒ‰éœ€ï¼‰
- åŸºäºåˆæ­¥ç†è§£è·å–é¢å¤–ä¸Šä¸‹æ–‡
- æ—¥å¿—: `thinking_loop.fetching_context`
- ä¸Šä¸‹æ–‡è§£æ: `thinking_loop.context_resolved`
- ç´¯ç§¯æ´å¯Ÿå¹¶å†æ¬¡åˆ†æ

**è¾“å‡ºå¥‘çº¦ (AnalysisModel)**:
```json
{
  "understanding": {
    "intent": "ç”¨æˆ·æ„å›¾",
    "entities": {...},
    "need_action": bool,
    "need_clarification": bool,
    "thinking_depth": 0-3,
    "original_content": "åŸå§‹æ¶ˆæ¯"
  },
  "context_requests": [...],
  "tool_plan": {"steps": [...]},
  "response_directives": {...}
}
```

### æ­¥éª¤4: æ¾„æ¸…å¤„ç† (`_handle_clarification`)
- ä»…åœ¨ `need_clarification=true` æ—¶è§¦å‘
- ç”Ÿæˆæ¾„æ¸…é—®é¢˜å¹¶ç›´æ¥è¿”å›
- æ—¥å¿—: `step4.clarification.returned`

### æ­¥éª¤5: æ‰§è¡Œå’Œå“åº” (`_execute_and_respond`)
1. **å·¥å…·æ‰§è¡Œ** (`_execute_tool_plan`):
   - è°ƒç”¨MCPå·¥å…·
   - æ”¯æŒéªŒè¯å¾ªç¯ï¼ˆæœ€å¤š3è½®ï¼‰
   - æ—¥å¿—: `tool_execution.verified_complete`

2. **å“åº”ç”Ÿæˆ** (`_generate_response`):
   - ç®€å•ç¡®è®¤ or è¯¦ç»†åˆ†æ
   - åŸºäº `response_directives.profile`
   - æ—¥å¿—: `step5.execution.completed`

### æ­¥éª¤6: å®éªŒè®°å½• (`_record_experiment_result`)
- è®°å½•A/Bæµ‹è¯•ç»“æœï¼ˆå¦‚æœå¯ç”¨ï¼‰
- ç”¨äºPromptä¼˜åŒ–è¿­ä»£

## ä¸Šä¸‹æ–‡ç®¡ç† (ContextManager)

### åŸºç¡€ä¸Šä¸‹æ–‡è·å– (`get_basic_context`)
```
æ—¥å¿—è¿½è¸ª:
- context.basic.fetching_memories
- context.memories.fetched (æ˜¾ç¤ºé¢„è§ˆ)
- context.household.fetched (å®¶åº­æˆå‘˜)
- context.basic.complete (æ€»è€—æ—¶)
```

### ä¸Šä¸‹æ–‡è¯·æ±‚è§£æ (`resolve_context_requests`)
æ”¯æŒçš„è¯·æ±‚ç±»å‹:
- `recent_memories`: æœ€è¿‘è®°å¿†
- `semantic_search`: è¯­ä¹‰æœç´¢ï¼ˆå¸¦åµŒå…¥å‘é‡ï¼‰
- `direct_search`: ç›´æ¥è¿‡æ»¤æŸ¥è¯¢
- `thread_summaries`: çº¿ç¨‹æ‘˜è¦

æ¯ä¸ªè¯·æ±‚éƒ½æœ‰è¯¦ç»†æ—¥å¿—:
- å¼€å§‹: `context.requests.resolving`
- å®Œæˆ: `context.requests.resolved`
- è€—æ—¶: `duration_ms`

## å·¥å…·æ‰§è¡Œå™¨ (ToolExecutor)

### æ‰§è¡Œæµç¨‹
1. è·å–å·¥å…·å…ƒæ•°æ®å’Œæ—¶é—´é¢„ç®—
2. æ‰§è¡Œå·¥å…·æ­¥éª¤ï¼ˆæ”¯æŒå¹¶è¡Œï¼‰
3. éªŒè¯ç»“æœå®Œæ•´æ€§
4. å¿…è¦æ—¶è¡¥å……æŸ¥è¯¢ï¼ˆéªŒè¯å¾ªç¯ï¼‰

### MCPå·¥å…·è°ƒç”¨ (`_call_mcp_tool`)
- HTTPè°ƒç”¨MCPæœåŠ¡å™¨
- è¯¦ç»†æ—¥å¿—: å·¥å…·åã€å‚æ•°ã€ç»“æœã€è€—æ—¶
- é”™è¯¯å¤„ç†å’Œé™çº§ç­–ç•¥

## æ€§èƒ½ä¼˜åŒ–

### ç¼“å­˜ç­–ç•¥
- **å‘é‡åµŒå…¥ç¼“å­˜**: ä¸¤çº§ç¼“å­˜ï¼ˆtraceçº§ + å…¨å±€LRUï¼‰
- **å·¥å…·å…ƒæ•°æ®ç¼“å­˜**: å‡å°‘é‡å¤è·å–
- **ä¸Šä¸‹æ–‡å¤ç”¨**: æ€è€ƒå¾ªç¯é—´å…±äº«

### Promptä¼˜åŒ– (v4_optimized)
- é™åˆ¶æ€è€ƒæ·±åº¦ï¼ˆ0-1çº§ï¼‰
- å‡å°‘ä¸Šä¸‹æ–‡è¯·æ±‚
- ç›´æ¥æ‰§è¡ŒåŸåˆ™
- ç®€æ´å›å¤æ¨¡å¼

### å¹¶å‘ä¼˜åŒ–
- å¤šä¸ªç‹¬ç«‹å·¥å…·å¯å¹¶è¡Œæ‰§è¡Œ
- ä¸Šä¸‹æ–‡è¯·æ±‚æ‰¹é‡å¤„ç†

## å…³é”®æ—¥å¿—ç‚¹ï¼ˆç”¨äºè°ƒè¯•ï¼‰

```python
# ä¸»æµç¨‹
"message.received"           # æ¶ˆæ¯æ¥æ”¶
"step1.preprocess.completed" # é¢„å¤„ç†å®Œæˆ
"step3.analysis.completed"   # åˆ†æå®Œæˆ
"step5.execution.completed"  # æ‰§è¡Œå®Œæˆ

# AIåˆ†æ
"analysis.round.started"     # åˆ†æè½®æ¬¡å¼€å§‹
"llm.response.summary"       # LLMå“åº”æ‘˜è¦
"llm.understanding.details"  # ç†è§£è¯¦æƒ…
"llm.tool_plan.details"      # å·¥å…·è®¡åˆ’

# ä¸Šä¸‹æ–‡
"context.basic.fetched"      # åŸºç¡€ä¸Šä¸‹æ–‡
"context.requests.resolved"  # è¯·æ±‚è§£æå®Œæˆ

# å·¥å…·æ‰§è¡Œ
"mcp.tool.calling"          # å·¥å…·è°ƒç”¨å¼€å§‹
"mcp.tool.success/failed"   # å·¥å…·æ‰§è¡Œç»“æœ
```

## é”™è¯¯å¤„ç†

### å¼‚å¸¸ç±»å‹
- `AnalysisError`: AIåˆ†æå¤±è´¥
- `ContextResolutionError`: ä¸Šä¸‹æ–‡è·å–å¤±è´¥
- `ToolPlanningError`: å·¥å…·è§„åˆ’å¤±è´¥
- `MCPToolError`: MCPå·¥å…·è°ƒç”¨å¤±è´¥
- `ToolTimeoutError`: å·¥å…·è¶…æ—¶
- `LLMError`: LLMè°ƒç”¨å¤±è´¥

### é™çº§ç­–ç•¥
1. è¿”å›å‹å¥½é”™è¯¯æ¶ˆæ¯
2. ä½¿ç”¨fallbackåˆ†æ
3. è®°å½•è¯¦ç»†é”™è¯¯æ—¥å¿—

## æ‰©å±•åŸåˆ™

### æ–°åŠŸèƒ½æ·»åŠ ï¼ˆæ— éœ€æ”¹ä»£ç ï¼‰
1. **ä¿®æ”¹Prompt**: è°ƒæ•´ `prompts/family_assistant_prompts.yaml`
2. **æ·»åŠ å·¥å…·**: åœ¨MCPæœåŠ¡å™¨æ·»åŠ ï¼Œæ›´æ–°å·¥å…·ç™½åå•
3. **è°ƒæ•´è¡Œä¸º**: é€šè¿‡Prompt blocksç»„åˆ

### èƒ½åŠ›è‡ªåŠ¨è¿›åŒ–
- AIæ¨¡å‹å‡çº§ â†’ ç†è§£èƒ½åŠ›æå‡
- æ•°æ®ç§¯ç´¯ â†’ ä¸ªæ€§åŒ–å¢å¼º
- Promptä¼˜åŒ– â†’ è¡Œä¸ºæ”¹è¿›

## é…ç½®è¦ç‚¹

### ç¯å¢ƒå˜é‡
- `LOW_BUDGET_MODE`: ä½æˆæœ¬æ¨¡å¼
- `MCP_SERVER_URL`: MCPæœåŠ¡åœ°å€
- `DEBUG`: è°ƒè¯•æ¨¡å¼ï¼ˆå½±å“æ—¥å¿—çº§åˆ«ï¼‰

### Promptç‰ˆæœ¬
- `v4_default`: å®Œæ•´åˆ†æç‰ˆ
- `v4_optimized`: å¿«é€Ÿå“åº”ç‰ˆï¼ˆæ¨èï¼‰

## ä½¿ç”¨å»ºè®®

### æ€§èƒ½ç›‘æ§
- å…³æ³¨ `thinking_rounds` ä¸åº”è¶…è¿‡2
- `duration_ms` åº”åœ¨10-15ç§’å†…
- å·¥å…·è°ƒç”¨æ¬¡æ•°åº”æœ€å°åŒ–

### æ—¥å¿—åˆ†æ
- ç”Ÿäº§ç¯å¢ƒç”¨INFOçº§åˆ«
- è°ƒè¯•æ—¶ç”¨DEBUGçº§åˆ«
- é‡ç‚¹å…³æ³¨ `step3.analysis` å’Œ `step5.execution`

### ä¼˜åŒ–æ–¹å‘
1. å‡å°‘æ€è€ƒå¾ªç¯ï¼ˆé€šè¿‡ä¼˜åŒ–Promptï¼‰
2. ç¼“å­˜å¸¸è§æŸ¥è¯¢ç»“æœ
3. å¹¶è¡ŒåŒ–ç‹¬ç«‹å·¥å…·è°ƒç”¨
4. ä½¿ç”¨èšåˆå·¥å…·æ›¿ä»£å¤šæ¬¡æŸ¥è¯¢