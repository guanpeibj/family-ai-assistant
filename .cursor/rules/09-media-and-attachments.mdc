---
alwaysApply: true
description: 媒体与附件（签名URL、派生文本、多模态占位）
---
## 媒体服务：[src/services/media_service.py](mdc:src/services/media_service.py)
- 签名链接：`make_signed_url(abs_path, expires_in_seconds)` → `/media/get?p=...&exp=...&sig=...`
- 验签：`verify_signature(rel, exp, sig)`；过期拒绝、MAC 不匹配拒绝。
- 路径安全：仅允许 `MEDIA_ROOT` 下文件访问，使用相对路径编码。

## 附件衍生
- `derive_for_attachments(attachments)`：
  - audio：优先 STT（OpenAI 兼容 `audio.transcriptions`），失败降级占位。
  - image：优先 Vision 摘要，降级 OCR 占位；受 `ENABLE_VISION/ENABLE_OCR` 控制。
  - 不修改原对象，返回新列表，字段可能含 `transcription/ocr_text/vision_summary`。

## Webhook 集成：[src/api/threema_webhook.py](mdc:src/api/threema_webhook.py)
- 接收 multipart 附件，保存至 `MEDIA_ROOT/YYYY/MM/` 并记录 `type/mime/path/size/original_name`。
- 后台任务派生文本并存储一条 `type=attachment_derivation` 的记忆（含 `attachments` 派生字段）。
- 引擎处理消息时会拼接“来自附件的文本”，提升理解准确度。

## 对外回退
- `/media/get` 用于签名回退；生产建议使用对象存储签名 URL 直连，不暴露后端路径。