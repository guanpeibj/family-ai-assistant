# 家庭ai助手（FAA）构想和规划

我计划自己开发一款ai应用，应用的名字是“ai家庭助手”(family ai assistant，简称FAA) 。作为个人项目，希望快速实现，逻辑 简单直接，同时以扩展，方便后来扩展。

## 主要作用

主要给家庭使用（首先面向我和我妻子），解决家庭实际需求：孩子多、杂事多，需要ai作为助理帮我们记忆、整理和提醒。整体来说，FAA的作用是，智能地接收、智能地储存我的家庭信息，并智能地分析家庭信息、做出智能地反馈，以及智能地提醒。用户可以 通过Threema robbot、Telegram robbot、http api、邮件、微信公众号/小程序的方式，和FAA沟通。在Threema 中，我已经为FFA准备了一个账号，FFA可以作为一个虚拟个体，在我和我妻子的家庭群中，和我们沟通。 

## 具体使用举例

1. 家庭记账和财务方面

具备完整的智能预算管理能力：

**基础记账**：自然对话即可
```
我："今天买菜花了80元"
faa："✅ 已记录，本月餐饮支出890元（30%）"
```

**智能预算管理**：
- 设置预算："设置本月预算10000元，餐饮3000、教育2000"
- 查询预算："这个月预算还剩多少？"
- 自动提醒："⚠️ 本月总支出已达8200元（82%），接近预算上限"
- 对话修改："下个月预算改为12000元"

**收支类目标准化**：
可配置，固定化，餐饮、交通、医疗、教育、娱乐、居住、服饰、日用、其他等
- AI智能映射，用户无需记忆类目
- 保证长期统计一致性
- "买菜"始终映射为"餐饮"，"打车"始终为"交通"

**智能分析与提醒**：
- 预算警告：自动检测80%、100%阈值
- 异常检测：大额支出、类目增长、频繁消费
- 趋势分析："医疗支出增长35%，注意家人健康"
- 个性化建议："餐饮支出较高，可以考虑在家做饭"

**月度财务报告**（自动生成）：
每月1号自动发送上月完整财务分析，包括收支总览、分类明细、异常提醒、改进建议。

**多维度查询**：
- 按时间："这个月比上个月多花了多少？"
- 按类目："近三个月餐饮支出趋势"
- 按人员："给大女儿花了多少钱？"
- 组合查询："9月份大女儿的教育支出"

**图表可视化**：
- 类目占比饼图
- 时间趋势折线图
- 多月对比柱状图

详见：[预算功能使用指南](docs/BUDGET_FEATURE_GUIDE.md)

2. 家庭成员健康方面

比如我通过threema/邮件，告知FAA“我的儿子今天身高是90cm，帮我记录”，当我说，“统计儿子身高体重变化趋势”，FAA会查出我儿子所有身高体重，列出一个曲线变化图。比如我会向FFA发送每次体检照片，FAA应该简单回应。如果我在咨询某个家庭成员的健康问题，FAA应该基于此成员过去相关的健康信息，给出针对这个家庭成员的健康建议。

3. 家庭杂事和提醒方面

FFA应该支持 记忆和查询 家庭成员基本信息、家庭全年 日程安排等，也支持提醒功能。比如“请记一下，下个月3号我需要给二女儿打疫苗，大女儿是10号打，提前一天提醒我” ，或者，“每天早上提醒我给孩子吃维生素A”。FAA会存储相关信息，并在指定时间完成“提醒”的动作（就是发送一条threema信息或一封邮件）。也应当处理信息变更，比如“帮我记录：我把大门钥匙放在沙发的垫子下面了”或“我家的wifi密码是123456”，后来我说“大门钥匙放到衣柜上面了。”FAA能自动更新。

4. 可能还包括其他方面，留够扩展可能，比如查询web功能，留够扩展可能，后续在考虑

## FFA的核心人设和风格

1. FAA的人设是一名衷心的老管家，他的特点和说话风格是：理性、专业、简洁、精炼、准确、有礼貌，充分表现出对主人家庭的尊重和关爱，应该尽量贴近真实的人类对话，不要过于机械化。
2. FAA应该支持自动询问和确认？这个很重要。比如，我发消息：“提醒我8.1号要给孩子打疫苗”，FAA先分析对话发现缺少关键必须项，然后FAA应该询问“请问您 需要我提醒在8.1给哪个孩子打疫苗？”。确定关键信息完整后，FAA会执行相关操作（存储完整信息，到时间提醒）。再比如，我妻子发消息：“记账：买了衣服“，FAA分析发现缺少必须项：金额和给谁买的衣服，并意识到支出时间应该默认就是现在时刻。于是询问”请问您刚刚给谁买了衣服，花了多少钱？“
3. FAA不触碰这些话题：宗教、情感寄托、家庭方向决定，如果遇到这些话题，应该礼貌地结束对话。


## 主要构成（暂时想到的，需调整优化补充）

1. 重点：FAA应该包括一个家庭专属的信息库，以适合ai 读/存的形式 来管理我们的日常信息，包括家庭财务收支明细、家庭成员健康信息、家庭其他杂事、以及其他家庭信息。
这个信息库的数据模块儿设计是一个重点，要重点设计。这个信息库应该是ai驱动的，尽量不做或少做预设的数据模型，尽量使用比较扁平的元数据模型。这样方便后续扩展，会使得 FAA随着 ai智能提升，会有更大扩展空间。比如 存储结构可以动态演化，AI自主发现数据间的关联。
同时，其中需要精确计算、统计的数据，比如家庭账目和家人健康信息（孩子某个日期的身高等等），也需要准确地储存和准确地查询。

需要一份初始化信息，我可以提供一份家庭成员详细情况，作为初始化时的信息
总之，信息库的设计是最重点的一部分，需要详细可靠设计，充分考虑 ai驱动、可扩展性、尽量预定义。

现在数据库里已经引入 `family_households / family_members / family_member_accounts` 三张极简结构表，用来描述一户家庭下的全部成员。成年人可以通过 `users`+`user_channels` 关联到成员节点，孩子或没有账号的成员则只需要维护 `family_members` 行即可。AI 仍然主导记忆结构，但在需要聚合/筛选时可以利用这些表给出的 `user_id` 列表来覆盖整个家庭或特定成员。

### AI 引擎工作流（统一循环版）

- **单循环 Plan→Act→Observe**：AI 在每轮中输出 JSON（thought/action/input），工程层只负责执行工具或补充上下文，再把 observation 写回下一轮，直到 LLM 主动 `finalize`。
- **上下文预算**：ContextManager 根据回合数裁剪 `light_context`、家庭成员和动态数据，Manifest 告知还可请求的键；AI 通过 `fetch_context` 主动索取新增数据。
- **工具调用**：LLM 直接决定调用何种 MCP 工具与参数；若失败，下一轮在 thought 中总结原因并调整策略，必要时以 `clarify` 结束并提问。
- **线程工作记忆**：LLM 在 `memory_record.extra.thread_scratchpad` 中维护该线程的最新主题、最近事务与待办，工程层会同步到 `thread_summary` 记录，后续回合可直接引用。
- **说话者与实体标签**：`light_context` 附带 `speaker`/`speaker_display`，`memory_record` 必须给出结构化实体与置信度，方便后续检索与更新。
- **最终回复契约**：最后一次调用要求输出 `{reply, memory_record, followups, status}`，工程层根据 `memory_record.should_store` 与 scratchpad 自动持久化，`reply` 直接返回用户。
- **记账类目约束**：Prompt 针对支出场景要求在调用工具前查询 `expense_category_config`，严格匹配一级/二级类目和 `alias`，若无匹配必须提示用户更新配置。
- **工具可见性**：系统与规划提示会动态注入 MCP 工具列表与参数规格，LLM 必须按提示词中的签名调用，每次规划前都能看到最新接口状态。
- **多任务拆解**：LLM 在 thought 中维护 `Tasks:` 清单，逐项执行并同步 thread_scratchpad/pendings，确保多目标对话井然有序。
- **工程职责**：除了上下文裁剪与工具桥接，仅保留安全兜底（超时、错误回退、提醒发送等），保证架构简洁可扩展。

### 日志与可观测性

- `agent.loop.context_snapshot`：记录每回合上下文预算使用情况（轻量记忆条数、家庭成员计数、动态键列表）。
- `agent.loop.plan_parsed`：展示 LLM 规划出的动作、关联工具、预期结果与 stop 标记。
- `agent.loop.observation_recorded`：归档执行后的观测摘要（成功与否、终止标记、是否更新上下文）。
- `agent.final.*`：包含最终汇总回合请求与成功事件，便于排查回复长度、followups 数量以及记忆写入开关。
- `store.thread_summary.upserted / store.thread_summary.failed`：记录线程工作记忆的同步结果，确保补充信息能在下一轮被引用。
- 其他关键日志（工具成功/失败、上下文请求、回退路径）同样保持英文，方便集中收集至 APM/Logging 平台。

### 上下文记忆策略

- 每次对话都会写入 `chat_turn` 记录，包含 `speaker`、`intent`、关键实体等结构化信息，供 `light_context` 快速读取。
- 若 LLM 输出 `thread_scratchpad`，引擎会将其保存为 `thread_summary`（按 `thread_id` 幂等更新），ContextManager 会在下次请求时自动注入。
- 当用户追加或更正信息时，Prompt 要求先从 `thread_summary` 或近期记录中检索再决定操作，避免重复创建或遗忘上文。

2. Prompt 编排全部集中在 `prompts/family_assistant_prompts.yaml`，后续扩展只需改 YAML 而无需改代码。

3. FAA应该包括一个可以接LLM api的组件，可能访问openai api / claude api / gemini api 等。由ai来决定这些重要问题：解析我和妻子的命令、是否存信息库以及如何存、是否查信息库以及如何查、已获得的信息如何给我们反馈。以上这些，尽量都交由ai决定，尽量少由代码和工程预定逻辑。

3. FFA 应该提供多种和 我们交互的方式，包括：Threema robbot、 http api（测试用）、Telegram、邮件，后续支持微信小程序、微信公众号、或是其他。FAA会作为家庭的Threema/telegram的一个共同好友，和家人在一个群里，以对话形式沟通，也有一个专门的邮箱，用户也可以以邮件形式沟通。
FAA 接收的内容格式支持文字、图片、语音等，FAA回复的格式目前支持文字/图片/表格等。

4. FAA使用MCP技术，使用一个（或多个）MCP server，用docker-compose管理，其中一个mcp server 专门负责 管理 信息库。后续或许可以集成多个 mcp server。

## 主要技术（如果你有其他推荐，可以提出）

python 3.12.11，openai 1.90.0，uv，MCP，PostgreSQL + pgvector， FastAPI

成本考虑，暂定都部署在 一个linux 云服务器，使用docker-compose管理，使用cursor开发，使用anysphere.remote-containers扩展来开发

应该具备简单的CICD能力，项github仓库提交代码，应该支持一键部署到目标云服务器，节省时间。

## 引擎设计更新

### Lossless Context Manifest
- Plan-Act 循环现在使用 manifest 描述上下文预算：每个动态键都会注明 `mode`、token 预算与 `ref`。对 `lossless` 键（如 `expense_category_config`），LLM 只能看到预览，必须通过 `fetch_context` + `kind="context_ref"` 拉取完整数据，彻底避免被截断的配置导致的幻觉。
- 历史 observation 追加了 `ref`，需要细节时使用 `kind="observation_ref"` 重放原始工具结果，日志仍保持精简。
- 上下文裁剪策略抽离到 `config/context_policy.yaml`，可按家庭需求配置 `lossless`/`summary`、优先级和 token 预算；工程代码不再写死阈值，遵循“AI 驱动 + prompt 编排”的理念。
- 工具查询（搜索类、预算、健康等）成功后会自动写入上下文的 lossless 视图，并把完整 `data` 直接提供给下一轮 LLM，确保不再依赖截断预览或重复查询。

### 快速响应路径
- LLM 可以在 `respond`/`finalize` 动作中直接给出 `reply`、`memory_record` 和 `followups`，引擎会立即返回结果，省去额外的总结调用，简单问题响应更快。
- 每轮循环都会记录 `context_build_ms`、`planning_llm_ms` 等指标，并写入 `AgentState.metadata.timings`，便于后续分析慢路径和优化提示词。
- `get_basic_context` 并发加载轻量记忆、家庭信息和线程摘要，家庭结构支持 60 秒缓存，减轻后端压力。


## 其他

项目在github上的地址是：https://github.com/guanpeibj/family-ai-assistant

总之，我希望FFA是一款 由ai驱动、尽量减少工程预设的、实在有用的ai应用。开发要求是，简单直接实现、便于理解、留够扩展可能 但不要过度设计。
